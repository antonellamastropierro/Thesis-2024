library(sf)
library(dplyr)
library(tidyr)
library(osmextract)
setwd("~/UNIBO/Internship and Thesis/R Thesis Project/Thesis Data")

# the coding use to obtain the osm shapefile
  # already cropped to the extent of the EA boundary shapefile using OECONVERT
query <- "SELECT * FROM 'lines' WHERE highway IN ('secondary', 'tertiary')"
ea_osm <- oe_read("alp_shpfiles/europe-latest.osm.pbf", 
                  query = query, layer = 'lines')
# function was successful in obtaining the secondary and tertiary roads for the
#...Alp extent

plot(ea_osm$geometry)

# saved the file
save(ea_osm, file = "alp_shpfiles/ea_osm.shp")
load("alp_shpfiles/ea_osm.shp")

# cleaned it up as it had some unneccesarry columns with NA values (i.e. barriers, waterways)
ea_osm_clean <- ea_osm[, -c(4,5,6,7,8,9)]
# result is shapefile with 671.8 MB and 793161 obs. of 4 variables


# load the Alp boundary shapefile
load("alp_shpfiles/EA.shp")

# my next step is to mask the OSM secondary and tertiary roads to only the ones
  #...within the ALp bondary shapefile
ea_osm_mask <- st_intersection(ea_osm_clean, EA)
# this is the function that is not working. It takes a long time, and then the 
  #... error I recieve is:
    # Error in wk_handle.wk_wkb(wkb, s2_geography_writer(oriented = oriented,  : 
    # Loop 0 is not valid: Edge 64 has duplicate vertex with edge 67

# I attempted to try by filtering out only the tertiary roads but it didn't work
ea_osm_tert <- filter(ea_osm_clean, highway == "tertiary")

# I checked to confirmed CRS are correct
st_crs(ea_osm_clean)==st_crs(EA)
# they are

# I looked online and found this code with changes everything to planar
sf_use_s2(FALSE)
# it didn't work


# attempted this as well but didn't work
sf_use_s2(FALSE)
ea_osm_planar <- st_make_valid(ea_osm_clean) 
mask <- st_intersection(ea_osm_planar, EA)
