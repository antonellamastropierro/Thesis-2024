# OBJECTIVE: To create and customize a virtual species living in Alpine conditions in Europe
# PART 1: Import environmental data/variables and crop to Europe
# PART 2: Isolate alpine env. variables using Europe alpine shapefile
# PART 3: Run correlation/VIF test on variables to test for multicollinearity
# PART 4: Retrieve mean and sd values for used bio variables
# PART 5: Create virtual species with specified conditions

################################################################################
# PRELIMINARY STEP: INSTALL AND LOAD PACKAGES

install.packages("virtualspecies")
install.packages("raster")

# to install and load ClimDatDownloadR for loading CHELSA data
# function is taken directly from GitHub
if(!require(devtools)) install.packages("devtools")
library(devtools)
devtools::install_github("HelgeJentsch/ClimDatDownloadR")

install.packages("usdm")
install.packages("tidyr")
install.packages("dplyr")
install.packages("sf")
install.packages("viridis")
install.packages("rnaturalearth")
install.packages("rnaturalearthdata")

# geographic maps
library(rnaturalearth)
library(rnaturalearthdata)

# plotting
library(ggplot2)

# geographic data and analysis
library(raster)

# mapping geographical data and obtaining bio variable data
library(ClimDatDownloadR)

# uncertainty analysis for species distribution models
library(usdm)

# data manipulation
library(tidyr)
library(dplyr)

# read shapefiles
library(sf)

# generate virtual species distributions
library(virtualspecies)

# creating blind color appropriate plots
library(viridis)

################################################################################
# PART 1: Import environmental data/variables
  # Section A: upload alpine climate shapefile
  # Section B: download bio variables from CHELSA and crop per alpine shapefile
# Purpose: to import environmental data to be used for observation of vs suitability
# data source: CHELSA
# package: ClimDatDownloadR

# Preliminary Step
# set the working directory where the files are saved/to be saved
setwd("~/UNIBO/Internship and Thesis/R Thesis Project/Thesis Data")
# or setwd("C:/Users/amast/OneDrive/Documents/UNIBO/Internship and Thesis/R Thesis Project/Thesis Data")

# Preliminary Step
# create a colorblind-inclusive color palette for all the plotting
vl <- viridis(100, option = "D")

# LEGEND
# alpine = alpine locations
# EUR = Europe
# bio = bio variables
# df = dataframe
# vs = virtual species

#-------------------------------------------------------------------------------
# Section A: upload alpine climate shapefile

# upload the shapefile first in order to be used for the bio variables cropping
alp <- st_read("global_alpine_30m_v1_1.shp")

# look at a description of the shapefile
print(alp)
# Geometry Type: Multipolygon
# Dimension: XY
# Extent: xmin: -179.9997 ymin: -55.42102 xmax: 179.9997 ymax: 70.47041
# Coords: +proj=longlat +datum=WGS84 +no_defs
# Column Names: continent, name, area_km2, geometry

# the project will focus on the alpine climate specifically in Europe

# to filter out only Europe alpine areas
alp_EUR <- filter(alp, continent == "Europe")

# view the extent of the shapefile for later use when cropping the bio variables
print(alp_EUR)
# Extent:  xmin: -9.779958 ymin: 36.98059 xmax: 66.89637 ymax: 70.47041

# look at the head and tail of the Europe shapefile to confirm only
# ... Europe polygons are included
head(alp_EUR)
tail(alp_EUR)
# confirmed as a Europe-only shapefile

# visualize the new Europe shapefile for confirmation
plot(alp_EUR$geometry)
# the geometry column is tagged as it contains the polygons
# not filtering out just the geometry column would result in three of the same plots
# shows the alpine locations in Europe

# add a background map to the shapefile for better visualization
# retrieve europe background map from rnaturalearth
EUR <- ne_countries(continent = "europe")

# plot for confirmation
plot(EUR$geometry)

# plot the two shapefiles and specify the extent to match the alpine Europe sf extent
alp_EUR_map <- ggplot() + 
  geom_sf(data = alp_EUR, fill = 'blue', color = 'blue', alpha = 0.5) +
  geom_sf(data = EUR, color = 'black', alpha = 0.5) + 
  coord_sf(xlim = c(-9.779958, 66.89637), ylim = c(36.98059, 70.47041)) +
  theme_minimal()
## MODIFY PLOT LATER FOR AESTHETICS

# visualize the plot to see alpine locations specific to European countries
plot(alp_EUR_map)
### WEIRD BLUE LINE AT TOP OF PLOT

dev.off()

#-------------------------------------------------------------------------------
# Section B: download bio variables from CHELSA and crop per alpine shapefile

# download the CHELSA bio variables and isolate specifically to Europe
Chelsa.Clim.download(parameter = "bio", version.var = "2.1",
                     clipping = TRUE, clip.shapefile = alp_EUR,
                     clip.extent = c(-9.779958, 66.89637, 36.98059, 70.47041),
                     stacking.data = TRUE)
# save.location: default is working directory
# bio.var: default is c(1:19)
# stacking.data set to TRUE

# upload the CHELSA bio variable data into R

# figure out this section
# list.files function: creates a character vector of the file names
bio_EUR_rastlist <- list.files(path ="~/UNIBO/Internship and Thesis/R Thesis Project/Thesis Data/bio/ChelsaV2.1Climatologies/clipped_2024-05-28_11-15-37",
                       pattern = "CHELSA", full.names = TRUE)
## Ask Rocio about what she did or the path to shorten it
# a character vector has been created which can be converted into a spatraster

# create a spatraster of the cropped bio variables in the character vector
bio_EUR <- rast(bio_EUR_rastlist)

# Plot one of the variables to confirm cropping
plot(bio_EUR[[1]])
# Extent matches the shapefile's extent of Europe
### REMEMBER TO EDIT PLOT WITH COLORS, TITLE, ETC

print(bio_EUR)
# class      : SpatRaster 
# dimensions : 4018, 9202, 36973636, 19  (nrow, ncol, ncell, nlayers)
# resolution : 0.008333333, 0.008333333  (x, y)
# extent     : -9.783473, 66.89986, 36.98319, 70.46653  (xmin, xmax, ymin, ymax)
# crs        : +proj=longlat +datum=WGS84 +no_defs 

dev.off()

# bio variables are now cropped to same extent as shapefile but need to be isolated
  # still to alpine condition locations in EURO


# show the current names of the uploaded bio variables
names(bio_EUR)
# Per the CHELSA website:
# BIO1 = Annual Mean Temperature
# BIO2 = Mean Diurnal Range (Mean of monthly (max temp - min temp))
# BIO3 = Isothermality (BIO2/BIO7) (×100)
# BIO4 = Temperature Seasonality (standard deviation ×100)
# BIO5 = Max Temperature of Warmest Month
# BIO6 = Min Temperature of Coldest Month
# BIO7 = Temperature Annual Range (BIO5-BIO6)
# BIO8 = Mean Temperature of Wettest Quarter
# BIO9 = Mean Temperature of Driest Quarter
# BIO10 = Mean Temperature of Warmest Quarter
# BIO11 = Mean Temperature of Coldest Quarter
# BIO12 = Annual Precipitation
# BIO13 = Precipitation of Wettest Month
# BIO14 = Precipitation of Driest Month
# BIO15 = Precipitation Seasonality (Coefficient of Variation)
# BIO16 = Precipitation of Wettest Quarter
# BIO17 = Precipitation of Driest Quarter
# BIO18 = Precipitation of Warmest Quarter
# BIO19 = Precipitation of Coldest Quarter

# to turn into RasterLayer
# worldclim_raster <- raster(worldclim)

# don't change the names of the bio variables yet because some of them will be
  # ...eliminated. Bio variable names will be changed after multicolinearity test

################################################################################
# PART 2: Isolate the bio variables located only in the Alpine shapefile polygons
# the European extent is shown but we need to isolate the bio variables to only
  # ... the values located in the alpine climate areas

# use the mask function to isolate only the Europe alpine values of the bio variables
bio_EUR_alp <- mask(bio_EUR, alp_EUR, inverse = FALSE)
# mask function(file to me masked, file to mask with)

# plot one of the variables to see if isolation/masking was successful
plot(bio_EUR_alp[[1]])
# the plot now shows the isolated alpine climate areas in the bio variable plot
## REMEMBER TITLE, COLORS, ETC FOR PLOT
names(bio_EUR_alp)
### QUESTION: BACKGROUND MAP???
### QUESTION: Is this right???
dev.off()

################################################################################
# PART 3: Run correlation/VIF test on variables to test for multicollinearity
# Purpose: to eliminate any unneeded variables by comparing the independent variables
# ... and testing for mulitcollinearity in order to avoid redundancy and overfitting
# package: usdm
# variance inflation factor (VIF): measure of the degree of multicollinearity
# ... of one regressor with the other regressors in a linear regression

# the bio variable names have to first be changed because the - in their original
  #...names is viewed as a mathematical expression and will cause an error in the
  #...colinearity test
names(bio_EUR_alp) <- c("bio1", "bio2", "bio3", "bio4", "bio5", "bio6", "bio7", "bio8", 'bio9', 'bio10',
                              'bio11', 'bio12', 'bio13', 'bio14', 'bio15', 'bio16', 'bio17', 'bio18', 'bio19')
names(bio_EUR_alp)
# the names are now changed in the spatraster

# Test the already isolated European alpine-specified variables
# vifcor() function runs a correlation test and VIF test
vifcor(bio_EUR_alp, th=0.7, keep = NULL,  method = 'pearson')
# th = threshold (0.9 is default)
# keep = if you want to keep a variable regardless of correlation
# size = # of cells to be tested (5,000 is default)
# method = method used to calculate pairwise correlation (pearson is default)
## THIS test takes a long ass time. Modify sampling size or maybe try different function

# The VIF/Correlation test returned: 3, 5, 8, 9, 13, 15
# BIO3 = Isothermality (BIO2/BIO7) (×100)
# BIO5 = Max Temperature of Warmest Month
# BIO8 = Mean Temperature of Wettest Quarter
# BIO9 = Mean Temperature of Driest Quarter
# BIO13 = Precipitation of Wettest Month
# BIO15 = Precipitation Seasonality (Coefficient of Variation)

# therefore, these are the 6 bio variables we want to use when creating the alpine VS

# now that the variables that do not have a colinearity problem are found,
  # ... filter out/eliminate the unneeded variables
bio_EUR_alp <- subset(bio_EUR_alp, c(3, 5, 8, 9, 13, 15))

# use the names () function to confirm the changes
names(bio_EUR_alp)
# it now shoes only have the 6 bio variables identified in the VIF test

# change the names of the variables to accurately identify the bio variables
names(bio_EUR_alp) <- c("Isothermality", "Max Temp of Warmest Month", 
                              "Mean Temp of Wettest Quarter", "Mean Temp of Driest Quarter",
                              "Precip of Wettest Month", "Precip Seasonality")

# confirm the names are changed
names(bio_EUR_alp)
# the names now align with the CHELSA descriptions of the variables
  # ...in the masked biovariable Europe alpine spatraster


# however, the unmasked Europe biovariable spatraster will be the one used when plotting the VS

# do the same filtering with the unmasked bio variable spatraster
  # ... because this raster will be the one used for the VS mapping
bio_EUR <- subset(bio_EUR, c(3, 5, 8, 9, 13, 15))

# confirm filtering has beeen successful
names(bio_EUR)
# now shows only the 6 variables identified in the VIF test

# change the names of the variables to match the ones in the masked Europe alpine spatraster
names(bio_EUR) <- c("Isothermality", "Max Temp of Warmest Month", 
                    "Mean Temp of Wettest Quarter", "Mean Temp of Driest Quarter",
                    "Precip of Wettest Month", "Precip Seasonality")

# confirm that the names have changed
names(bio_EUR)

################################################################################
# PART 4: Retrieve mean and sd values for used bio variables
# Purpose: in order to create a custom alpine VS

# the spatraster containing the values at each pixel need to be converted to dataframes
  # ...in order to retrieve the mean and sd values for each of the 7 bio variable
  # ...to input into our custom alpine VS

# convert the masked Europe alpine climate-specific spatraster into a dataframe
bio_EUR_alp_df <- as.data.frame(bio_EUR_alp)

# view the dataframe
glimpse(bio_EUR_alp_df)
# now it's a dataframe, showing all the values of each of the 6 variables located
  #... specifically in the alpine climate areas of Europe

# Get the means and SDs of each variable to input later into the VS

# to get the means of all 6 variables at the same time
colMeans(bio_EUR_alp_df)
# Isothermality = 0.2320626
# Max Temp of Warmest Month = 11.7147893    
# Mean Temp of Wettest Quarter =  2.0501391 
# Mean Temp of Driest Quarter = -5.4827879
# Precip of Wettest Month = 210.2364574
# Precip Seasonality = 30.0971283

# retrieve SD of all 6 variables
summarize_all(bio_EUR_alp_df, sd)
# Isothermality = 0.05526883
# Max Temp of Warmest Month = 1.813004
# Mean Temp of Wettest Quarter = 6.142773
# Mean Temp of Driest Quarter = 7.174399
# Precip of Wettest Month = 80.24957
# Precip Seasonality = 8.399545

# the means and SDs have now been determined for the necessary 6 variables
# these values will be used to create a custom alpine-specific VS

################################################################################
# PART 5: Create virtual species with specified conditions
# Purpose: using the alpine-specific values for each of bio variable, a alpine-specific
# VS can be created
# SUBSECTIONS:
# A: create env. suitability plot
# B: create presence/absence plot
# C: Sample occurrence points

#-------------------------------------------------------------------------------
# A: Create Environmental Suitability Plot

# first create parameters for alpine species using the mean and SD values retrieved
# ... from part 4
# the raster used will be the unmasked European biovariable raster to show the
# ...VS suitability in relation to all of Europe
alp_pmtrs <- formatFunctions(x=bio_EUR,
                             "Isothermality" = c(fun = "dnorm", mean = 0.2320626, sd = 0.05526883),
                             "Max Temp of Warmest Month" = c(fun ='dnorm', mean = 11.7147893, sd = 1.813004),
                             "Mean Temp of Wettest Quarter"= c(fun = "dnorm", mean = 2.0501391, sd = 6.142773),
                             "Mean Temp of Driest Quarter"= c(fun = "dnorm", mean = -5.4827879, sd = 7.174399),
                             "Precip of Wettest Month" = c(fun = "dnorm", mean = 210.2364574, sd = 80.24957),
                             "Precip Seasonality"= c(fun = "dnorm", mean = 30.0971283, sd = 8.399545))
# the response function plot automatically comes up


# input the alpine-specific parameters to generate an alpine-specific VS
alp_vs_1 <- generateSpFromFun(raster.stack = bio_EUR,
                            parameters = alp_pmtrs,
                            plot = TRUE)
# shows the env. suitability for Europe specific to alpine species


dev.off()

# to save the first alpine VS generated
save(alp_vs_1, file = "alp_vs_1")

# to load the alpine VS
load(file = "alp_vs_1")

# to visualize the response functions that were inputted
plotResponse(alp_vs_1)
# all gaussian curves. Visualized the peak suitability values for each of the 7 variables

dev.off()
#-------------------------------------------------------------------------------
# B: Create presence/absence plot

# use converttoPA() function to convert the suitability plot into a binary presence/absence plot
alp_pa_1 <- convertToPA(alp_vs_1, beta = 0.7, alpha = -0.07, plot = FALSE)
# beta = inflection point of curve
# lower beta = wider distribution range (increase probability of finding suitable conditions)
# higher beta = smaller distribution range (decrease probability of finding suitable conditions)
# alpha = slope of curve ranging from linear to logistic to threshold like
# species prevalence: number of places occupied by the species
#... out of the total number of available places
conver
# for alpine vs maybe good to make higher beta
# maybe better to specify species prevalence to 3% since I found documents saying
# ... Alpine occupies 3% of world
# alp_pa <- convertToPA(alp_vs, beta = 'random', alpha = -0.07, species.prevalence = 0.03,
# plot = TRUE)
alp_pa_1
# species prevalence = 0.000277
plot(alp_pa_1)
# plot the pa.raster: the presence-absence map, as a Raster object containing 0 (absence) / 1 (presence) / NA
plot(alp_pa_1$pa.raster)
alp_pa_1$pa.raster
# CREATE GOOD COLOR PALETTE
# for suitability: alp_pa$suitab.raster
# for prob. of occurrence: alp_pa$probability.of.occurrence


dev.off()

#-------------------------------------------------------------------------------
# C: Sample occurrence points
# Purpose: to sample presence only points from P/A plot
  # Presence only shows realized niche

# to show the number of cells
raster(alp_pa_1$pa.raster)
# number of cells = 36973636. This equals the max number of present points

alp_presence_1 <- sampleOccurrences(alp_pa_1, n = 100,  sample.prevalence = 0.9,
                                    correct.by.suitability = TRUE, type = "presence only")
# n = # of points to sample
# PLOT IS COMPLETELY MESSED UP
print(alp_presence_1)

# Type: presence only
# Number of points: 100
# No sampling bias
# Detection probability: 
# Probability: 1
# Corrected by suitability: FALSE
# Probability of identification error (false positive): 0

### Question: should the sample prevalence be changed?

dev.off()

### QUESTION: if sampling in Alpine locations, but alpine only covers 3% of world
  #...would isolating and continuously sampling only in Europe be too little?
